/*  ADBS_A320  */


#include <Wire.h>
#include <ADBS_A320.h>

const int ADDR = 0x6b;

//----------------A320 Sensor pin define----------------
#define NRSTPIN 3       // PIN NRST connect to arduino pin 3
#define MotionPIN 4     // PIN Motion connect to arduino pin 4
#define OrientPIN 5     // PIN Orient connect to arduino pin 5
#define SHTDWNPIN 8     // PIN SHTDWN connect to arduino pin 8
	                // SDA (data line) is on analog input pin A4, and SCL (clock line) is on analog input pin A5

void setup()
{
      Serial.begin(9600);
    
    //------------OFN Sensor------------
    Wire.begin();// join i2c bus (address optional for master)
//    delay(100);
//    Wire.beginTransmission(ADDR);
//    Wire.endTransmission();
    
    //--------------PIN mode ------------------ 
    pinMode(SHTDWNPIN, OUTPUT);
    pinMode(MotionPIN, INPUT);
    pinMode(OrientPIN, OUTPUT);
    pinMode(NRSTPIN, OUTPUT); 
    
    //--------------Power Up----------------------
    digitalWrite(SHTDWNPIN, LOW);
    digitalWrite(OrientPIN, HIGH); 
    //Serial.println("Hello A320");
    delay(100);
    digitalWrite(NRSTPIN, LOW);
    delayMicroseconds(20);
    digitalWrite(NRSTPIN, HIGH);
    delay(10);
    // Serial.println("Hello A320-1");
    Init();
}

 
void loop()
{
  Serial.println("There is A320");
  //Self_test();

  //if(digitalRead(MotionPIN) == LOW)
  //{
     read_register(ADDR, Motion); 
     read_register(ADDR, Delta_X); 
     read_register(ADDR, Delta_Y);
     Serial.println("There is Motion");
     delay(500);  
  //}
  /*else
  {
    Serial.println("Waiting for Motion"); 
    delay(500);    
  } */ 
}


void  Self_test(void){

  set_register(ADDR, Soft_RESET, 0x5a);
  set_register(ADDR, OFN_Engine, 0xf6);
  set_register(ADDR, OFN_Quantize_CTRL, 0xaa);
  set_register(ADDR, OFN_Speed_Control, 0xc4);
  set_register(ADDR, Self_Test, 0x01);
  delay(250);
  
  read_register(ADDR, CRC0);
  read_register(ADDR, CRC1);
  read_register(ADDR, CRC2);
  read_register(ADDR, CRC3);
}
void Init(void)
{
    set_register(ADDR, Soft_RESET, 0xe4);
    set_register(ADDR, OFN_Engine, 0xe4); 
    set_register(ADDR, OFN_Resolution, 0x12);      //500cpi
    set_register(ADDR, OFN_Speed_Control, 0x0e);    //Speed of switching 12ms, low cpi 250
    set_register(ADDR, OFN_Speed_ST12, 0x08);
    set_register(ADDR, OFN_Speed_ST21, 0x06); 
    set_register(ADDR, OFN_Speed_ST23, 0x40);      
    set_register(ADDR, OFN_Speed_ST32, 0x08); 
    set_register(ADDR, OFN_Speed_ST34, 0x48);
    set_register(ADDR, OFN_Speed_ST43, 0x0a); 
    set_register(ADDR, OFN_Speed_ST45, 0x50);      //500cpi
    set_register(ADDR, OFN_Speed_ST54, 0x48);    //Speed of switching 12ms, low cpi 250
    set_register(ADDR, OFN_AD_CTRL, 0xc4);
    set_register(ADDR, OFN_AD_ATH_HIGH, 0x34); 
    set_register(ADDR, OFN_AD_DTH_HIGH, 0x3c);      //500cpi
    set_register(ADDR, OFN_AD_ATH_LOW, 0x18); 
    set_register(ADDR, OFN_AD_DTH_LOW, 0x20);
    set_register(ADDR, OFN_FPD_CTRL, 0x50);
    
    read_register(ADDR, Motion); 
    read_register(ADDR, Delta_X); 
    read_register(ADDR, Delta_Y); 
}
void set_register(int address, unsigned char reg, unsigned char val) {
  Wire.beginTransmission(address);
  Wire.write(reg);
  Wire.write(val);
  Wire.endTransmission();
}

void read_register(int address, unsigned char reg) {
  Wire.beginTransmission(address);
  Wire.write(reg);
  Wire.endTransmission();
  
  Wire.requestFrom(address, 1);
  while (Wire.available())   // slave may send less than requested
  {
    int Val = Wire.read(); // receive a byte as character
    Serial.println(Val,HEX);         // print the character
  }
  delay(500);
}
